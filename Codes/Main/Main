#include "initOfVals.h"       // Zde inicializuji všechny proměnné.
#include "index.h"       // Zde inicializuji všechny proměnné.

TaskHandle_t Task1;
TaskHandle_t Task2;

void handleRoot() {
 String s = MAIN_page; 
 // Pošle webovou stránku serveru
 server.send(200, "text/html", s); 
}
void handlevaluesX() { 
  for (var i=0; i<17; i++) {
    let X=String(strd[i][0]); 
    server.send(200, "text/plane", (i+1).toString() + "&" + X);  
  }
}
void handlevaluesY() { 
  for (var i=0; i<17; i++) {
    let Y=String(strd[i][1]); 
    server.send(200, "text/plane", (i+1).toString() + "&" + Y);  
  }
}
void handleLED() {
 String led0State = "OFF";
 String led1State = "OFF";

 // Odkazuje na xhttp.open("GET", "setLED?LEDstate="+led, true); v index.h
 String t_state = server.arg("LEDstate"); 
 Serial.println(t_state);
 if(t_state == "0"){
    led0State = "ON";
    led1State = "OFF";
    valG = 1;
    valB = 0;
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);
    runallowed = true;
 }
 if(t_state == "1"){
    led0State = "OFF";
    led1State = "ON";
    valG = 0;
    valB = 1; 
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);
    runallowed = false;  
 }

 // Pošle webovou stránku serveru
 server.send(200, "text/plane", led0State);
 server.send(200, "text/plane", led1State);  
}

////   Setup funkce:  ////
void setup() {
  Serial.begin(115200);

  // Server
  WiFi.mode(WIFI_AP); 
  WiFi.softAP(ssid, password);

  Serial.println("Connecting to ");
  Serial.print(ssid);    
  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP IP address: ");
  Serial.println(IP); 
  server.on("/", handleRoot);      
  server.on("/setLED", handleLED);
  server.on("/readValuesX", handleValuesX);
  server.on("/readValuesY", handleValuesY);
 
  server.begin();                  
  Serial.println("HTTP server started");

  //create a task that will be executed in the Task1code() function, with priority 1 and executed on core 0
  xTaskCreatePinnedToCore(Task1code,"Task1",10000,NULL,1,&Task1,0);                 

  //create a task that will be executed in the Task2code() function, with priority 1 and executed on core 1
  xTaskCreatePinnedToCore(Task2code,"Task2",10000,NULL,1,&Task2,1);        

  // Nastavení motorů pro AccelStepper
  Yaxis2.setPinsInverted(true,false,false);   // Pro upravení správného směru
  Xaxis.setPinsInverted(true,false,false); 

  Yaxis1.setMaxSpeed(5000);                   // Nastavení maximálních rychlostí
  Yaxis2.setMaxSpeed(5000);
  Xaxis.setMaxSpeed(7500);

  Yaxis1.setSpeed(2500);                   // Nastavení rychlostí
  Yaxis2.setSpeed(2500);
  Xaxis.setSpeed(2500);

  // Nastavení pinů koncových spínačů
  pinMode(koncak1, INPUT);              
  pinMode(koncak2, INPUT);
  pinMode(koncak3, INPUT);
  pinMode(koncak4, INPUT);

  // Piny pro tlacitka
  pinMode(buttonPinR, INPUT);
  pinMode(buttonPinG, INPUT);
  pinMode(buttonPinB, INPUT);

  pinMode(ledPinR, OUTPUT);
  pinMode(ledPinG, OUTPUT);
  pinMode(ledPinB, OUTPUT);

  // Nastavení pinu senzoru IR
  pinMode(senzor, INPUT);

  // Nastavení enable pinu pro blokování chodu motorů "enable" a jeho okamžité zapnutí pro blokaci náhodného chodu po startu.
  pinMode(enableY, OUTPUT);
  pinMode(enableX, OUTPUT);
  digitalWrite(enableY, HIGH);
  digitalWrite(enableX, HIGH);


  // Po načtení ukončí setup a přejde do loopu.
  Serial.print("\nSETUP FINISHED\n");
}

#include "basicFunctions.h"   // Zde inicializuji všechny vedlejší vytvořené funkce.
#include "Routes.h"           // Zde inicializuji hlavní oběhovou funkci.

////   Hlavní loops:   ////
void Task1code( void * pvParameters ){
  for(;;){
    server.handleClient(); 
    delay(10);
  }
}
void Task2code( void * pvParameters ){
  for(;;){
    basicRoute();
    delay(10);
  }
}  
void loop(){
}
