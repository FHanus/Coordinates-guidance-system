#include "initOfVals.h"       // Zde inicializuji všechny proměnné.
#include "index.h"       // Zde inicializuji všechny proměnné.

TaskHandle_t Task1;

void handleRoot() {
 String s = MAIN_page; 
 // Pošle webovou stránku serveru
 server.send(200, "text/html", s); 
}

void handlevalues() {
  if(strdporadi==1){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]));   
  }
  if(strdporadi==2){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]));     
  }
  if(strdporadi==3){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]));     
  }
  if(strdporadi==4){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]));       
  }
  if(strdporadi==5){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]));       
  }
  if(strdporadi==6){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]));      
  }
  if(strdporadi==7){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]));     
  }
  if(strdporadi==8){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]));       
  }
  if(strdporadi==9){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]));   
  }
  if(strdporadi==10){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]));        
  }
  if(strdporadi==11){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]));      
  }
  if(strdporadi==12){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]) + "," + String(strd[12][0]) + "," + String(strd[12][1]));      
  }
  if(strdporadi==13){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]) + "," + String(strd[12][0]) + "," + String(strd[12][1]) + "," + String(strd[13][0]) + "," + String(strd[13][1]));    
  }
  if(strdporadi==14){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]) + "," + String(strd[12][0]) + "," + String(strd[12][1]) + "," + String(strd[13][0]) + "," + String(strd[13][1]) + "," + String(strd[14][0]) + "," + String(strd[14][1]));    
  }
  if(strdporadi==15){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]) + "," + String(strd[12][0]) + "," + String(strd[12][1]) + "," + String(strd[13][0]) + "," + String(strd[13][1]) + "," + String(strd[14][0]) + "," + String(strd[14][1]) + "," + String(strd[15][0]) + "," + String(strd[15][1]));
  }
  if(strdporadi==16){
    server.send(200, "text/plane", String(strd[0][0]) + "," + String(strd[0][1]) + "," + String(strd[1][0]) + "," + String(strd[1][1]) + "," + String(strd[2][0]) + "," + String(strd[2][1]) + "," + String(strd[3][0]) + "," + String(strd[3][1]) + "," + String(strd[4][0]) + "," + String(strd[4][1]) + "," + String(strd[5][0]) + "," + String(strd[5][1]) + "," + String(strd[6][0]) + "," + String(strd[6][1]) + "," + String(strd[7][0]) + "," + String(strd[7][1]) + "," + String(strd[8][0]) + "," + String(strd[8][1]) + "," + String(strd[9][0]) + "," + String(strd[9][1]) + "," + String(strd[10][0]) + "," + String(strd[10][1]) + "," + String(strd[11][0]) + "," + String(strd[11][1]) + "," + String(strd[12][0]) + "," + String(strd[12][1]) + "," + String(strd[13][0]) + "," + String(strd[13][1]) + "," + String(strd[14][0]) + "," + String(strd[14][1]) + "," + String(strd[15][0]) + "," + String(strd[15][1]) + "," + String(strd[16][0]) + "," + String(strd[16][1]));
  } 
}

void handleLED() {
 String led0State = "OFF";
 String led1State = "OFF";

 // Odkazuje na xhttp.open("GET", "setLED?LEDstate="+led, true); v index.h
 String t_state = server.arg("LEDstate"); 
 Serial.println(t_state);
 if(t_state == "0"){
    led0State = "ON";
    led1State = "OFF";
    valG = 1;
    valB = 0;
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);
    runallowed = true;
 }
 if(t_state == "1"){
    led0State = "OFF";
    led1State = "ON";
    valG = 0;
    valB = 1; 
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);
    runallowed = false;  
 }

 // Pošle webovou stránku serveru
 server.send(200, "text/plane", led0State);
 server.send(200, "text/plane", led1State);  
}

////   Setup funkce:  ////
void setup() {
  Serial.begin(115200);

  // Server
  WiFi.mode(WIFI_AP); 
  WiFi.softAP(ssid, password);

  Serial.print("Connecting to ");
  Serial.println(ssid);    
  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP IP address: ");
  Serial.println(IP); 
  server.on("/", handleRoot);      
  server.on("/setLED", handleLED);
  server.on("/readValues", handlevalues);
 
  server.begin();                  
  Serial.println("HTTP server started");

  //create a task that will be executed in the Task1code() function, with priority 1 and executed on core 0
  xTaskCreatePinnedToCore(Task1code,"Task1",10000,NULL,1,&Task1,0);                       

  // Nastavení motorů pro AccelStepper
  Yaxis2.setPinsInverted(true,false,false);   // Pro upravení správného směru
  Xaxis.setPinsInverted(true,false,false); 

  Yaxis1.setMaxSpeed(5000);                   // Nastavení maximálních rychlostí
  Yaxis2.setMaxSpeed(5000);
  Xaxis.setMaxSpeed(7500);

  Yaxis1.setSpeed(2500);                   // Nastavení rychlostí
  Yaxis2.setSpeed(2500);
  Xaxis.setSpeed(2500);

  // Nastavení pinů koncových spínačů
  pinMode(koncak1, INPUT);              
  pinMode(koncak2, INPUT);
  pinMode(koncak3, INPUT);
  pinMode(koncak4, INPUT);

  // Piny pro tlacitka
  pinMode(buttonPinR, INPUT);
  pinMode(buttonPinG, INPUT);
  pinMode(buttonPinB, INPUT);

  pinMode(ledPinR, OUTPUT);
  pinMode(ledPinG, OUTPUT);
  pinMode(ledPinB, OUTPUT);

  // Nastavení pinu senzoru IR
  pinMode(senzor, INPUT);

  // Nastavení enable pinu pro blokování chodu motorů "enable" a jeho okamžité zapnutí pro blokaci náhodného chodu po startu.
  pinMode(enableY, OUTPUT);
  pinMode(enableX, OUTPUT);
  digitalWrite(enableY, HIGH);
  digitalWrite(enableX, HIGH);


  // Po načtení ukončí setup a přejde do loopu.
  Serial.print("\nSETUP FINISHED\n");
}

#include "basicFunctions.h"   // Zde inicializuji všechny vedlejší vytvořené funkce.
#include "Routes.h"           // Zde inicializuji hlavní oběhovou funkci.

////   Hlavní loops:   ////
void Task1code( void * pvParameters ){
  for(;;){
    server.handleClient(); 
    delay(10);
  }
}
void loop(){
  basicRoute();
}
