#include "initOfVals.h"       // Zde inicializuji všechny proměnné.
#include "index.h"       // Zde inicializuji všechny proměnné.

TaskHandle_t Task1;

void handleRoot() {
 String s = MAIN_page; 
 // Pošle webovou stránku serveru
 server.send(200, "text/html", s); 
}

void handlevalues() {
  message = (String(strd[0][0]) + "," + String(strd[0][1])); 
  for(int i=1; i<13;i++){
    for(int d=0; d<2;d++){
      if((strd[i][d])!=0){
        mest = String(strd[i][d]);         
      }
      else{
        mest = ("N/A"); 
      } 
      message = (message + "," + mest); 
    }
  }
  server.send(200, "text/plane", message); 
}

void handleLED() {
 String led0State = "OFF";
 String led1State = "OFF";

 // Odkazuje na xhttp.open("GET", "setLED?LEDstate="+led, true); v index.h
 String t_state = server.arg("LEDstate"); 
 if(t_state == "0"){
    led0State = "ON";
    led1State = "OFF";
    valG = 1;
    valB = 0;
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);   
    poradnikMan=1;
    runM=0;
    runallowed = true;
 }
 if(t_state == "1"){
    led0State = "OFF";
    led1State = "ON";
    valG = 0;
    valB = 1; 

    poradnik = 0;
    merX[0] = 0;   
    merX[1] = 0;               
    merY[0] = 0;   
    merY[1] = 0;   
    lastPos[0] = 0;   
    lastPos[1] = 0;   
    lastPosWD[0] = 0;   
    lastPosWD[1] = 0;   
    mathValX = 0;
    mathValY = 0;

    oldPos[0]=Xaxis.currentPosition();
    oldPos[1]=Yaxis1.currentPosition();


    runM=0;
    poradnikMan=1;
    digitalWrite(ledPinG, valG);
    digitalWrite(ledPinB, valB);
    runallowed = false;  
 }

 if(t_state == "2"){
   KrokMan = "Yp";
 }
 if(t_state == "3"){
    KrokMan = "Xm";
 }
 if(t_state == "4"){
   KrokMan = "S";
 }
 if(t_state == "5"){
    KrokMan = "Xp";
 }
 if(t_state == "6"){
    KrokMan = "Ym";
 }


 // Pošle webovou stránku serveru
 server.send(200, "text/plane", led0State);
 server.send(200, "text/plane", led1State);  
}

void handleForm() { 
 //oldDesiredPos = desiredPos;
 desiredPos = server.arg("position"); 

 //if(desiredPos!=oldDesiredPos){
  runM = 1;
 //}

 //String s = MAIN_page;
 //server.send(200, "text/html", s); //Send web page
 server.sendHeader("Location", "/");
 server.send(302, "text/plain", "Updated-- Press Back Button"); 	
}


////   Setup funkce:  ////
void setup() {
  Serial.begin(115200);

  // Server
  WiFi.mode(WIFI_AP); 
  WiFi.softAP(ssid, password);

  Serial.print("Connecting to ");
  Serial.println(ssid);    
  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP IP address: ");
  Serial.println(IP); 
  server.on("/", handleRoot);      
  server.on("/setLED", handleLED);
  server.on("/readValues", handlevalues);
  server.on("/form", handleForm);

  server.begin();                  
  Serial.println("HTTP server started");

  //create a task that will be executed in the Task1code() function, with priority 1 and executed on core 0
  xTaskCreatePinnedToCore(Task1code,"Task1",10000,NULL,1,&Task1,0);                       

  // Nastavení motorů pro AccelStepper
  Yaxis2.setPinsInverted(true,false,false);   // Pro upravení správného směru
  Xaxis.setPinsInverted(true,false,false); 

  Yaxis1.setMaxSpeed(5000);                   // Nastavení maximálních rychlostí
  Yaxis2.setMaxSpeed(5000);
  Xaxis.setMaxSpeed(7500);

  Yaxis1.setSpeed(2500);                   // Nastavení rychlostí
  Yaxis2.setSpeed(2500);
  Xaxis.setSpeed(2500);

  // Nastavení pinů koncových spínačů
  pinMode(koncak1, INPUT);              
  pinMode(koncak2, INPUT);
  pinMode(koncak3, INPUT);
  pinMode(koncak4, INPUT);

  // Piny pro tlacitka
  pinMode(buttonPinR, INPUT);
  pinMode(buttonPinG, INPUT);
  pinMode(buttonPinB, INPUT);

  pinMode(ledPinR, OUTPUT);
  pinMode(ledPinG, OUTPUT);
  pinMode(ledPinB, OUTPUT);

  // Nastavení pinu senzoru IR
  pinMode(senzor, INPUT);

  // Nastavení enable pinu pro blokování chodu motorů "enable" a jeho okamžité zapnutí pro blokaci náhodného chodu po startu.
  pinMode(enableY, OUTPUT);
  pinMode(enableX, OUTPUT);
  digitalWrite(enableY, HIGH);
  digitalWrite(enableX, HIGH);


  // Po načtení ukončí setup a přejde do loopu.
  Serial.print("\nSETUP FINISHED\n");
}

#include "basicFunctions.h"   // Zde inicializuji všechny vedlejší vytvořené funkce.
#include "Routes.h"           // Zde inicializuji hlavní oběhovou funkci.

////   Hlavní loops:   ////
void Task1code( void * pvParameters ){
  for(;;){
    server.handleClient(); 
    
    delay(10);
  }
}
void loop(){
  basicRoute();
  delayMicroseconds(25);
}
